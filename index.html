<!DOCTYPE html>
<html>
<head>
  <title>Tabel Penghasilan Sawit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Gaya CSS tetap sama seperti sebelumnya */
  </style>
</head>
<body>
  <h2>Tabel Penghasilan Bulan Agustus 2025</h2>
  <div style="overflow-x:auto;">
    <table id="tabelSawit">
      <thead>
        <tr id="headerRow">
          <th>Tanggal</th>
          <th>Asroful</th>
          <th>Jumahir</th>
          <th>Rahim</th>
          <th>Kamran</th>
          <th>Hartono</th>
          <th>Selamet</th>
          <th>Dhali</th>
          <th>Zul azmi</th>
          <th>Pojol</th>
          <th>Rosid</th>
          <th>Total/Hari</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
      <tfoot>
        <tr id="footerRow">
          <td>Total/Orang</td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td class="colTotal"></td>
          <td id="grandTotal"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="btn-container">
    <button onclick="requestSave()">üíæ Simpan Data</button>
    <button onclick="requestDelete()">üóë Hapus Data</button>
    <button onclick="addColumn()">‚ûï Tambah Kolom</button>
    <button onclick="deleteColumn()">‚ûñ Hapus Kolom</button>
    <button onclick="exportTableToExcel()">‚¨áÔ∏è Export ke Excel</button>
    <a class="whatsapp-btn" href="https://wa.me/601141340245" target="_blank">üì≤ Hubungi Admin via WhatsApp</a>
    <div class="note">‚ö†Ô∏è Data hanya tersimpan di browser, refresh akan tetap menyimpan jika sudah klik Simpan.</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <script>
    // Konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "API_KEY_ANDA",
      authDomain: "PROJECT_ID.firebaseapp.com",
      databaseURL: "https://PROJECT_ID.firebaseio.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);

    const ADMIN_CODE = "opunkGX";
    const tableBody = document.getElementById("tableBody");
    const headerRow = document.getElementById("headerRow");
    const footerRow = document.getElementById("footerRow");

    // Buat 31 baris
    for (let i = 1; i <= 31; i++) {
      const row = document.createElement("tr");

      const hariCell = document.createElement("td");
      hariCell.textContent = " " + i;
      row.appendChild(hariCell);

      for (let j = 0; j < 10; j++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number"; input.step = "any"; input.dataset.row = i; input.dataset.col = j;
        input.oninput = hitungTotal;
        td.appendChild(input);
        row.appendChild(td);
      }

      const totalCell = document.createElement("td");
      const totalInput = document.createElement("input");
      totalInput.type = "number"; totalInput.step = "any"; totalInput.classList.add("rowTotal"); totalInput.dataset.row = i;
      totalInput.oninput = () => {
        const total = parseFloat(totalInput.value);
        if (isNaN(total)) return;
        const inputs = row.querySelectorAll("td input:not(.rowTotal)");
        const perOrang = (total / inputs.length).toFixed(2);
        inputs.forEach(inp => inp.value = perOrang);
        hitungTotal();
      };
      totalCell.appendChild(totalInput);
      row.appendChild(totalCell);

      tableBody.appendChild(row);
    }

    function hitungTotal() {
      const rows = tableBody.querySelectorAll("tr");
      const colCount = headerRow.querySelectorAll("th").length - 2;
      const colTotals = Array(colCount).fill(0);
      let grandTotal = 0;

      rows.forEach(row => {
        const inputs = row.querySelectorAll("td input:not(.rowTotal)");
        let rowTotal = 0;
        inputs.forEach((inp, idx) => {
          const val = parseFloat(inp.value);
          if (!isNaN(val)) { colTotals[idx] += val; rowTotal += val; inp.value = val.toFixed(2); }
        });
        const totalInput = row.querySelector(".rowTotal");
        if (totalInput && document.activeElement !== totalInput) totalInput.value = rowTotal.toFixed(2);
        grandTotal += rowTotal;
      });

      const colTotalCells = footerRow.querySelectorAll(".colTotal");
      colTotalCells.forEach((cell, idx) => {
        cell.textContent = colTotals[idx] ? colTotals[idx].toFixed(2) : "";
      });
      document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
    }

    // Simpan/load data
    function saveData() {
      const data = {};
      document.querySelectorAll("input").forEach(input => {
        const key = `r${input.dataset.row || "x"}c${input.dataset.col || "total"}`;
        data[key] = input.value;
      });
      const userId = "user123"; // Ganti dengan ID pengguna yang sesuai
      const userRef = database.ref('users/' + userId);
      userRef.set(data);
      alert("‚úÖ Data berhasil disimpan!");
    }

    function loadData() {
      const userId = "user123"; // Ganti dengan ID pengguna yang sesuai
      const userRef = database.ref('users/' + userId);
      userRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          document.querySelectorAll("input").forEach(input => {
            const key = `r${input.dataset.row || "x"}c${input.dataset.col || "total"}`;
            if (data[key] !== undefined) input.value = data[key];
          });
          hitungTotal();
        }
      });
    }

    function requestSave() {
      const kode = prompt("Masukkan kode admin untuk simpan data:");
      if (kode === ADMIN_CODE) saveData();
      else if (kode) alert("‚ùå Kode salah!");
    }

    function requestDelete() {
      const kode = prompt("Masukkan kode admin untuk hapus data:");
      if (kode === ADMIN_CODE) {
        if (confirm("Yakin hapus semua data?")) {
          const userId = "user123"; // Ganti dengan ID pengguna yang sesuai
          const userRef = database.ref('users/' + userId);
          userRef.remove();
          document.querySelectorAll("input").forEach(input => input.value = "");
          hitungTotal();
          alert("üóë Semua data telah dihapus!");
        }
      } else if (kode) alert("‚ùå Kode salah!");
    }

    // Fungsi tambah/hapus kolom dan export ke Excel tetap sama seperti sebelumnya

    window.onload = loadData;
  </script>
</body>
</html>
